import{k as O,l as H,r as $,j as e,M as N,aT as T,m as P,F as Q,aE as d,o as r,a3 as c,p as i,B as L,b as f,b0 as G,a4 as x,at as o,Q as C,I as M,U as K,g as J,b2 as Y,h as Z,b1 as z,aF as k,aG as A,aH as h,aI as n,aJ as R,aK as l}from"./index-DE3WvtMD.js";import{A as V,C as E,S as _}from"./scroll-area-DRcAvLaD.js";import{C as W}from"./calendar-DiUGKtnE.js";import{F as X}from"./filter-BKVlahs0.js";import{D as ee}from"./database-BF2X_8bV.js";function ce(){const{user:y}=O(),{toast:U}=H(),[m,v]=$.useState({startDate:new Date(Date.now()-30*24*60*60*1e3).toISOString().split("T")[0],endDate:new Date().toISOString().split("T")[0]});if(!y||y.role!=="admin")return e.jsx(N,{children:e.jsx("div",{className:"container mx-auto py-10",children:e.jsxs("div",{className:"text-center",children:[e.jsx(T,{className:"mx-auto h-12 w-12 text-destructive mb-4"}),e.jsx("h1",{className:"text-2xl font-bold mb-2",children:"Access Denied"}),e.jsx("p",{className:"text-muted-foreground",children:"You need admin permissions to access the telemetry dashboard."})]})})});const{data:j,isLoading:I,error:u,refetch:b}=P({queryKey:["/api/admin/telemetry-metrics",m.startDate,m.endDate],queryFn:async()=>{const s=new URLSearchParams({startDate:m.startDate,endDate:m.endDate});return await(await Q("GET",`/api/admin/telemetry-metrics?${s}`)).json()},refetchInterval:6e4}),q=()=>{b(),U({title:"Data refreshed",description:`Telemetry data updated for ${m.startDate} to ${m.endDate}`})},w=s=>new Date(s).toLocaleString(),g=s=>`${s}ms`,D=(s,a)=>a===0?"0%":`${Math.round(s/a*100)}%`,S=s=>{const a={search_perf:"default",listing_view:"secondary",contact_click:"outline",message_posted:"default",reply_within_48h:"secondary",accepted_match:"default",deal_done:"default"};return e.jsx(f,{variant:a[s]||"outline",children:s})};if(I)return e.jsx(N,{children:e.jsxs("div",{className:"container mx-auto py-6 space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx(d,{className:"h-8 w-64 mb-2"}),e.jsx(d,{className:"h-4 w-96"})]})}),e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[1,2,3,4].map(s=>e.jsxs(r,{children:[e.jsx(c,{className:"pb-2",children:e.jsx(d,{className:"h-4 w-24"})}),e.jsxs(i,{children:[e.jsx(d,{className:"h-8 w-16 mb-1"}),e.jsx(d,{className:"h-3 w-20"})]})]},s))}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs(r,{children:[e.jsx(c,{children:e.jsx(d,{className:"h-6 w-32"})}),e.jsx(i,{children:e.jsx(d,{className:"h-32 w-full"})})]}),e.jsxs(r,{children:[e.jsx(c,{children:e.jsx(d,{className:"h-6 w-32"})}),e.jsx(i,{children:e.jsx(d,{className:"h-32 w-full"})})]})]})]})});if(u||!(j!=null&&j.ok))return e.jsx(N,{children:e.jsx("div",{className:"container mx-auto py-10",children:e.jsxs("div",{className:"text-center",children:[e.jsx(T,{className:"mx-auto h-12 w-12 text-destructive mb-4"}),e.jsx("h1",{className:"text-2xl font-bold mb-2",children:"Error Loading Telemetry Data"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:(u==null?void 0:u.message)||"Failed to fetch telemetry metrics"}),e.jsx(L,{onClick:()=>b(),children:"Try Again"})]})})});const{dashboard:t,meta:F}=j;return e.jsx(N,{children:e.jsxs("div",{className:"container mx-auto py-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Telemetry Dashboard"}),e.jsx("p",{className:"text-muted-foreground",children:"Platform analytics and user behavior insights"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(f,{variant:"outline",className:"text-sm",children:[e.jsx(G,{className:"w-3 h-3 mr-1"}),"Admin Access"]}),e.jsxs(f,{variant:"secondary",className:"text-sm",children:[e.jsx(V,{className:"w-3 h-3 mr-1"}),"Live Data"]})]})]}),e.jsxs(r,{children:[e.jsxs(c,{children:[e.jsxs(x,{className:"flex items-center gap-2",children:[e.jsx(W,{className:"w-5 h-5"}),"Date Range Filter"]}),e.jsxs(o,{children:["Select date range for telemetry analysis. Last updated: ",w(F.generatedAt)]})]}),e.jsx(i,{children:e.jsxs("div",{className:"flex items-end gap-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(C,{htmlFor:"startDate",children:"Start Date"}),e.jsx(M,{"data-testid":"input-start-date",id:"startDate",type:"date",value:m.startDate,onChange:s=>v(a=>({...a,startDate:s.target.value}))})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(C,{htmlFor:"endDate",children:"End Date"}),e.jsx(M,{"data-testid":"input-end-date",id:"endDate",type:"date",value:m.endDate,onChange:s=>v(a=>({...a,endDate:s.target.value}))})]}),e.jsxs(L,{"data-testid":"button-apply-filters",onClick:q,className:"flex items-center gap-2",children:[e.jsx(X,{className:"w-4 h-4"}),"Apply Filters"]})]})})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsxs(r,{"data-testid":"card-total-events",children:[e.jsxs(c,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(x,{className:"text-sm font-medium",children:"Total Events"}),e.jsx(ee,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(i,{children:[e.jsx("div",{className:"text-2xl font-bold",children:t.summary.totalEvents.toLocaleString()}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[t.summary.dataPoints," data points collected"]})]})]}),e.jsxs(r,{"data-testid":"card-unique-users",children:[e.jsxs(c,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(x,{className:"text-sm font-medium",children:"Unique Users"}),e.jsx(K,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(i,{children:[e.jsx("div",{className:"text-2xl font-bold",children:t.summary.uniqueUsers.toLocaleString()}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Active users in selected period"})]})]}),e.jsxs(r,{"data-testid":"card-avg-search-latency",children:[e.jsxs(c,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(x,{className:"text-sm font-medium",children:"Avg Search Latency"}),e.jsx(J,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(i,{children:[e.jsx("div",{className:"text-2xl font-bold",children:g(t.summary.avgSearchLatency)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Average response time"})]})]}),e.jsxs(r,{"data-testid":"card-quick-replies",children:[e.jsxs(c,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(x,{className:"text-sm font-medium",children:"Quick Replies"}),e.jsx(Y,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(i,{children:[e.jsx("div",{className:"text-2xl font-bold",children:t.latestMetrics?D(t.latestMetrics.quickReplies,t.latestMetrics.totalMessages):"N/A"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Replies within 48h"})]})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs(r,{"data-testid":"card-event-breakdown",children:[e.jsxs(c,{children:[e.jsxs(x,{className:"flex items-center gap-2",children:[e.jsx(E,{className:"w-5 h-5"}),"Event Type Distribution"]}),e.jsx(o,{children:"Breakdown of events by type in selected period"})]}),e.jsx(i,{children:e.jsxs("div",{className:"space-y-3",children:[Object.entries(t.eventBreakdown).sort(([,s],[,a])=>a-s).map(([s,a])=>{const p=t.summary.totalEvents>0?Math.round(a/t.summary.totalEvents*100):0;return e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[S(s),e.jsx("span",{className:"text-sm font-medium",children:s})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm font-bold",children:a.toLocaleString()}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[p,"%"]})]})]},s)}),Object.keys(t.eventBreakdown).length===0&&e.jsx("div",{className:"text-center py-4",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"No events in selected period"})})]})})]}),e.jsxs(r,{"data-testid":"card-latest-metrics",children:[e.jsxs(c,{children:[e.jsxs(x,{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"w-5 h-5"}),"Latest Metrics"]}),e.jsx(o,{children:"Current platform performance indicators"})]}),e.jsx(i,{children:t.latestMetrics?e.jsxs("div",{className:"grid gap-4 grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm",children:"Active Users"}),e.jsx("span",{className:"font-bold",children:t.latestMetrics.activeUsers})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm",children:"Total Searches"}),e.jsx("span",{className:"font-bold",children:t.latestMetrics.totalSearches})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm",children:"Search Latency"}),e.jsx("span",{className:"font-bold",children:g(t.latestMetrics.avgSearchLatency)})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm",children:"Messages"}),e.jsx("span",{className:"font-bold",children:t.latestMetrics.totalMessages})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm",children:"Quick Replies"}),e.jsx("span",{className:"font-bold",children:t.latestMetrics.quickReplies})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm",children:"Reply Rate"}),e.jsx("span",{className:"font-bold",children:D(t.latestMetrics.quickReplies,t.latestMetrics.totalMessages)})]})]})]}):e.jsx("div",{className:"text-center py-4",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"No latest metrics available"})})})]})]}),e.jsxs(r,{"data-testid":"card-recent-events",children:[e.jsxs(c,{children:[e.jsxs(x,{className:"flex items-center gap-2",children:[e.jsx(z,{className:"w-5 h-5"}),"Recent Events"]}),e.jsxs(o,{children:["Latest ",t.recentEvents.length," telemetry events"]})]}),e.jsx(i,{children:e.jsx(_,{className:"h-[400px]",children:e.jsxs(k,{children:[e.jsx(A,{children:e.jsxs(h,{children:[e.jsx(n,{children:"Event Type"}),e.jsx(n,{children:"User"}),e.jsx(n,{children:"Timestamp"}),e.jsx(n,{children:"Details"})]})}),e.jsxs(R,{children:[t.recentEvents.map((s,a)=>e.jsxs(h,{children:[e.jsx(l,{children:S(s.eventType)}),e.jsx(l,{children:e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("span",{className:"text-sm font-medium",children:["User #",s.userId||"Anonymous"]}),s.userRole&&e.jsx(f,{variant:"outline",className:"text-xs w-fit",children:s.userRole})]})}),e.jsx(l,{children:e.jsx("span",{className:"text-sm text-muted-foreground",children:w(s.timestamp)})}),e.jsx(l,{children:e.jsxs("div",{className:"text-sm",children:[s.listingId&&e.jsxs("div",{children:["Listing: #",s.listingId]}),s.threadId&&e.jsxs("div",{children:["Thread: #",s.threadId]}),s.metadata&&Object.keys(s.metadata).length>0&&e.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:Object.entries(s.metadata).slice(0,2).map(([p,B])=>e.jsxs("div",{children:[p,": ",String(B)]},p))})]})})]},s.id||a)),t.recentEvents.length===0&&e.jsx(h,{children:e.jsx(l,{colSpan:4,className:"text-center py-8",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"No recent events found"})})})]})]})})})]}),e.jsxs(r,{"data-testid":"card-daily-snapshots",children:[e.jsxs(c,{children:[e.jsxs(x,{className:"flex items-center gap-2",children:[e.jsx(E,{className:"w-5 h-5"}),"Daily Snapshots"]}),e.jsx(o,{children:"Historical daily metrics and trends"})]}),e.jsx(i,{children:e.jsx(_,{className:"h-[400px]",children:e.jsxs(k,{children:[e.jsx(A,{children:e.jsxs(h,{children:[e.jsx(n,{children:"Date"}),e.jsx(n,{children:"Active Users"}),e.jsx(n,{children:"Listings"}),e.jsx(n,{children:"Contacts"}),e.jsx(n,{children:"Matches"}),e.jsx(n,{children:"Deals"}),e.jsx(n,{children:"Search Latency"})]})}),e.jsxs(R,{children:[t.dailySnapshots.sort((s,a)=>new Date(a.date).getTime()-new Date(s.date).getTime()).map((s,a)=>e.jsxs(h,{children:[e.jsx(l,{className:"font-medium",children:new Date(s.date).toLocaleDateString()}),e.jsx(l,{children:s.active_users}),e.jsx(l,{children:s.live_listings}),e.jsx(l,{children:s.daily_contacts}),e.jsx(l,{children:s.accepted_matches}),e.jsx(l,{children:s.deals}),e.jsx(l,{children:g(s.p95_search_latency_ms)})]},s.id||a)),t.dailySnapshots.length===0&&e.jsx(h,{children:e.jsx(l,{colSpan:7,className:"text-center py-8",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"No daily snapshots available"})})})]})]})})})]})]})})}export{ce as default};
