import{j as e,H as E,J as T,K as O,N as A,O as x,Q as y,I as P,R as ee,r as o,V as se,W as te,X as z,Y as U,Z as ae,_ as ie,$ as re,a as $,a0 as ne,m as H,b as q,a1 as R,a2 as ce,o as D,a3 as Q,a4 as K,p as V,a5 as M,B as F,k as Y,l as le,i as oe,a6 as de,a7 as me,n as xe,M as L,a8 as _}from"./index-DE3WvtMD.js";import{a as ue}from"./http-DXHry6-L.js";import{T as he}from"./textarea-DxM8kpuO.js";async function pe(){const s=await fetch("/api/taxonomy");if(!s.ok)throw new Error(`Failed to load taxonomy: ${s.status} ${s.statusText}`);const a=await s.json();if(!a.categories||!a.subtypes||!a.regions)throw new Error("Invalid taxonomy data: missing required fields");return a}function ge({taxonomy:s,value:a,onChange:t}){const i=a.category?s.subtypes[a.category]??[]:[];return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"What are you listing?"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs(E,{value:a.category,onValueChange:r=>t({category:r,subtype:""}),children:[e.jsx(T,{children:e.jsx(O,{placeholder:"Category (required)"})}),e.jsx(A,{children:s.categories.map(r=>e.jsx(x,{value:r.code,children:r.label},r.code))})]}),e.jsxs(E,{value:a.subtype,onValueChange:r=>t({...a,subtype:r}),disabled:!a.category,children:[e.jsx(T,{children:e.jsx(O,{placeholder:"Subtype (required)"})}),e.jsx(A,{children:i.map(r=>e.jsx(x,{value:r.code,children:r.label},r.code))})]})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Choosing category first tailors the next steps to the right specs and compliance."})]})}function ye({category:s,subtype:a,value:t,onChange:i}){return e.jsxs("div",{className:"space-y-6",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Product Details"}),e.jsx("div",{className:"p-3 bg-blue-50 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("strong",{children:"Selected:"})," ",s," â†’ ",a]})}),e.jsxs("div",{className:"grid grid-cols-1 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"title",children:"Product Title *"}),e.jsx(P,{id:"title",value:t.title,onChange:r=>i({title:r.target.value}),placeholder:"Enter a descriptive title for your product"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"specs",children:"Quality Specifications"}),e.jsx(he,{id:"specs",value:t.qualitySpecs,onChange:r=>i({qualitySpecs:r.target.value}),placeholder:"Describe the quality specs, potency, testing results, etc.",rows:4})]})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Provide clear, accurate details about your ",s.toLowerCase()," product to help buyers understand what you're offering."]})]})}function je({value:s,onChange:a}){return e.jsxs("div",{className:"space-y-6",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Commercial Terms"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"quantity",children:"Quantity Available *"}),e.jsx(P,{id:"quantity",type:"number",value:s.quantity,onChange:t=>a({quantity:Number(t.target.value)}),placeholder:"e.g. 100",min:"0"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"region",children:"Region *"}),e.jsxs(E,{value:s.region,onValueChange:t=>a({region:t}),children:[e.jsx(T,{children:e.jsx(O,{placeholder:"Select region"})}),e.jsxs(A,{children:[e.jsx(x,{value:"western-cape",children:"Western Cape"}),e.jsx(x,{value:"eastern-cape",children:"Eastern Cape"}),e.jsx(x,{value:"northern-cape",children:"Northern Cape"}),e.jsx(x,{value:"kwazulu-natal",children:"KwaZulu-Natal"}),e.jsx(x,{value:"free-state",children:"Free State"}),e.jsx(x,{value:"gauteng",children:"Gauteng"}),e.jsx(x,{value:"mpumalanga",children:"Mpumalanga"}),e.jsx(x,{value:"limpopo",children:"Limpopo"}),e.jsx(x,{value:"north-west",children:"North West"})]})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-medium",children:"Pricing"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"pricePerUnit",children:"Fixed Price per Unit (ZAR)"}),e.jsx(P,{id:"pricePerUnit",type:"number",value:s.pricePerUnit||"",onChange:t=>a({pricePerUnit:t.target.value?Number(t.target.value):void 0}),placeholder:"25.00",min:"0",step:"0.01"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"priceMin",children:"Or Min Price (ZAR)"}),e.jsx(P,{id:"priceMin",type:"number",value:s.priceMin||"",onChange:t=>a({priceMin:t.target.value?Number(t.target.value):void 0}),placeholder:"20.00",min:"0",step:"0.01"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"priceMax",children:"Max Price (ZAR)"}),e.jsx(P,{id:"priceMax",type:"number",value:s.priceMax||"",onChange:t=>a({priceMax:t.target.value?Number(t.target.value):void 0}),placeholder:"30.00",min:"0",step:"0.01"})]})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Either provide a fixed price per unit OR a price range (min/max). Range pricing allows for negotiation."})]})]})}var B="Checkbox",[be,qe]=ee(B),[fe,Ne]=be(B),Z=o.forwardRef((s,a)=>{const{__scopeCheckbox:t,name:i,checked:r,defaultChecked:n,required:p,disabled:g,value:d="on",onCheckedChange:v,form:j,...b}=s,[u,C]=o.useState(null),k=se(a,m=>C(m)),w=o.useRef(!1),N=u?j||!!u.closest("form"):!0,[h=!1,c]=te({prop:r,defaultProp:n,onChange:v}),l=o.useRef(h);return o.useEffect(()=>{const m=u==null?void 0:u.form;if(m){const S=()=>c(l.current);return m.addEventListener("reset",S),()=>m.removeEventListener("reset",S)}},[u,c]),e.jsxs(fe,{scope:t,state:h,disabled:g,children:[e.jsx(z.button,{type:"button",role:"checkbox","aria-checked":f(h)?"mixed":h,"aria-required":p,"data-state":J(h),"data-disabled":g?"":void 0,disabled:g,value:d,...b,ref:k,onKeyDown:U(s.onKeyDown,m=>{m.key==="Enter"&&m.preventDefault()}),onClick:U(s.onClick,m=>{c(S=>f(S)?!0:!S),N&&(w.current=m.isPropagationStopped(),w.current||m.stopPropagation())})}),N&&e.jsx(ve,{control:u,bubbles:!w.current,name:i,value:d,checked:h,required:p,disabled:g,form:j,style:{transform:"translateX(-100%)"},defaultChecked:f(n)?!1:n})]})});Z.displayName=B;var W="CheckboxIndicator",X=o.forwardRef((s,a)=>{const{__scopeCheckbox:t,forceMount:i,...r}=s,n=Ne(W,t);return e.jsx(ae,{present:i||f(n.state)||n.state===!0,children:e.jsx(z.span,{"data-state":J(n.state),"data-disabled":n.disabled?"":void 0,...r,ref:a,style:{pointerEvents:"none",...s.style}})})});X.displayName=W;var ve=s=>{const{control:a,checked:t,bubbles:i=!0,defaultChecked:r,...n}=s,p=o.useRef(null),g=ie(t),d=re(a);o.useEffect(()=>{const j=p.current,b=window.HTMLInputElement.prototype,C=Object.getOwnPropertyDescriptor(b,"checked").set;if(g!==t&&C){const k=new Event("click",{bubbles:i});j.indeterminate=f(t),C.call(j,f(t)?!1:t),j.dispatchEvent(k)}},[g,t,i]);const v=o.useRef(f(t)?!1:t);return e.jsx("input",{type:"checkbox","aria-hidden":!0,defaultChecked:r??v.current,...n,tabIndex:-1,ref:p,style:{...s.style,...d,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})};function f(s){return s==="indeterminate"}function J(s){return f(s)?"indeterminate":s?"checked":"unchecked"}var G=Z,Ce=X;const I=o.forwardRef(({className:s,...a},t)=>e.jsx(G,{ref:t,className:$("peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",s),...a,children:e.jsx(Ce,{className:$("flex items-center justify-center text-current"),children:e.jsx(ne,{className:"h-4 w-4"})})}));I.displayName=G.displayName;function ke({value:s,onChange:a}){const{data:t}=H({queryKey:["documents"],queryFn:async()=>{const i=await fetch("/api/documents");if(!i.ok)throw new Error("Failed to fetch documents");return i.json()}});return o.useEffect(()=>{t&&Array.isArray(t)&&t.some(r=>{var n;return["license","licence","certificate","registration"].includes((n=r.documentType)==null?void 0:n.toLowerCase())})&&!s.licenceOnFile&&a({licenceOnFile:!0})},[t,s.licenceOnFile,a]),e.jsxs("div",{className:"space-y-6",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Compliance & Trading Preferences"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(I,{id:"licence",checked:s.licenceOnFile,onCheckedChange:i=>a({licenceOnFile:!!i})}),e.jsx(y,{htmlFor:"licence",className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",children:"I have the required licenses and certificates on file"}),s.licenceOnFile&&e.jsxs(q,{variant:"outline",className:"text-green-600 border-green-200",children:[e.jsx(R,{className:"w-3 h-3 mr-1"}),"Confirmed"]})]}),t&&t.length>0&&e.jsx("div",{className:"ml-6 space-y-1",children:t.filter(i=>{var r;return["license","licence","certificate","registration","coa"].includes((r=i.documentType)==null?void 0:r.toLowerCase())}).map((i,r)=>e.jsxs("div",{className:"flex items-center space-x-2 text-sm text-gray-600",children:[e.jsx(ce,{className:"w-3 h-3"}),e.jsxs("span",{children:["Already uploaded: ",i.originalName||i.fileName]}),e.jsx(q,{variant:"secondary",className:"text-xs",children:i.documentType})]},r))})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(I,{id:"anonymity",checked:s.anonymity,onCheckedChange:i=>a({anonymity:!!i})}),e.jsx(y,{htmlFor:"anonymity",className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",children:"Trade anonymously (use trading name instead of legal entity name)"})]})]}),e.jsxs("div",{className:"p-4 bg-amber-50 border border-amber-200 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-amber-800 mb-2",children:"Compliance Requirements"}),e.jsxs("ul",{className:"text-sm text-amber-700 space-y-1",children:[e.jsx("li",{children:"â€¢ Valid business license required for all cannabis trading"}),e.jsx("li",{children:"â€¢ Certificate of Analysis (COA) must be available upon request"}),e.jsx("li",{children:"â€¢ All products must comply with local cannabis regulations"}),e.jsx("li",{children:"â€¢ Proper storage and handling certifications recommended"})]})]}),e.jsxs("div",{className:"p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-blue-800 mb-2",children:"Trading Name vs Legal Name"}),e.jsx("p",{className:"text-sm text-blue-700",children:"Anonymous trading allows you to use a trading name publicly while keeping your legal entity name private. This is common in cannabis trading for privacy reasons while maintaining full compliance."})]})]})}function we({value:s,onSubmit:a}){const t=[{label:"Category & Subtype selected",valid:!!(s.category&&s.subtype)},{label:"Product title provided",valid:!!s.title},{label:"Region specified",valid:!!s.region},{label:"Quantity set",valid:s.quantity>0},{label:"Pricing provided",valid:!!(s.pricePerUnit||s.priceMin&&s.priceMax)},{label:"License compliance confirmed",valid:s.licenceOnFile}],i=t.every(n=>n.valid),r=()=>{i&&a(s)};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Review Your Listing"}),e.jsxs(D,{children:[e.jsx(Q,{children:e.jsxs(K,{className:"flex items-center justify-between",children:[e.jsx("span",{children:s.title||"Untitled Listing"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(q,{variant:"secondary",children:s.category}),e.jsx(q,{variant:"outline",children:s.subtype})]})]})}),e.jsxs(V,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Location"}),e.jsx("p",{className:"text-lg",children:s.region||"Not specified"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Quantity"}),e.jsxs("p",{className:"text-lg",children:[s.quantity," units"]})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Pricing"}),e.jsx("p",{className:"text-lg",children:s.pricePerUnit?`R${s.pricePerUnit} per unit`:s.priceMin&&s.priceMax?`R${s.priceMin} - R${s.priceMax} per unit`:"Not specified"})]}),s.qualitySpecs&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Quality Specifications"}),e.jsx("p",{className:"text-sm text-gray-800",children:s.qualitySpecs})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[s.licenceOnFile?e.jsx(R,{className:"h-4 w-4 text-green-600"}):e.jsx(M,{className:"h-4 w-4 text-red-600"}),e.jsx("span",{className:"text-sm",children:"License Compliance"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[s.anonymity?e.jsx(R,{className:"h-4 w-4 text-blue-600"}):e.jsx(M,{className:"h-4 w-4 text-gray-400"}),e.jsx("span",{className:"text-sm",children:"Anonymous Trading"})]})]})]})]}),e.jsxs(D,{children:[e.jsx(Q,{children:e.jsx(K,{children:"Publishing Checklist"})}),e.jsxs(V,{children:[e.jsx("div",{className:"space-y-3",children:t.map((n,p)=>e.jsxs("div",{className:"flex items-center gap-2",children:[n.valid?e.jsx(R,{className:"h-4 w-4 text-green-600"}):e.jsx(M,{className:"h-4 w-4 text-red-600"}),e.jsx("span",{className:`text-sm ${n.valid?"text-green-800":"text-red-800"}`,children:n.label})]},p))}),!i&&e.jsx("div",{className:"mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg",children:e.jsx("p",{className:"text-sm text-amber-800",children:"Please complete all required fields before publishing your listing."})})]})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(F,{onClick:r,disabled:!i,size:"lg",className:"bg-green-600 hover:bg-green-700",children:"Publish Listing"})})]})}function Se(){const[s,a]=o.useState(0),[t,i]=o.useState({category:"",subtype:"",title:"",region:"",quantity:0,priceMin:void 0,priceMax:void 0,pricePerUnit:void 0,qualitySpecs:"",licenceOnFile:!1,anonymity:!0}),{user:r}=Y(),{toast:n}=le(),p=oe(),g=de(),{acting:d}=me(),{data:v,isLoading:j,error:b,refetch:u}=H({queryKey:["taxonomy"],queryFn:pe,staleTime:36e5,retry:2}),C=s===0&&!(t.category&&t.subtype),k=xe({mutationFn:async c=>{const l={...c};return d.mode==="seller"&&d.sellerId&&(l.actingForSellerId=d.sellerId),(await ue("/api/listings",{method:"POST",body:JSON.stringify(l)})).json()},onSuccess:()=>{g.invalidateQueries({queryKey:["/api/listings"]}),n({title:"Success!",description:"Your listing has been created successfully."}),p("/dashboard")},onError:c=>{n({title:"Error",description:c.message||"Failed to create listing. Please try again.",variant:"destructive"})}}),w=async c=>{if((r==null?void 0:r.role)==="broker"&&d.mode!=="seller"){n({title:"Missing Authorization",description:"Brokers must select a seller to act for using the header switcher.",variant:"destructive"});return}console.log("Submitting listing:",c),k.mutate(c)};if(j)return e.jsx("div",{className:"p-8 text-center",children:"Loading taxonomy..."});if(b||!v)return e.jsxs("div",{className:"p-8 text-center space-y-4",children:[e.jsxs("div",{className:"text-red-600",children:["Failed to load taxonomy: ",(b==null?void 0:b.message)||"Unknown error"]}),e.jsx("button",{onClick:()=>u(),className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",children:"Retry"})]});const N=[e.jsx(ge,{taxonomy:v,value:{category:t.category,subtype:t.subtype},onChange:c=>i(l=>({...l,...c}))}),e.jsx(ye,{category:t.category,subtype:t.subtype,value:t,onChange:i}),e.jsx(je,{value:t,onChange:i}),e.jsx(ke,{value:t,onChange:i}),e.jsx(we,{value:t,onSubmit:w})],h=["Category","Specs","Pricing/Quantity/Region","Compliance/Anonymity","Preview"];return e.jsxs("div",{className:"max-w-3xl mx-auto p-4",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-neutral-800 mb-2",children:"Create New Listing"}),e.jsx("div",{className:"flex items-center space-x-4 mb-4",children:h.map((c,l)=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${l===s?"bg-blue-600 text-white":l<s?"bg-green-600 text-white":"bg-gray-200 text-gray-600"}`,children:l+1}),l<h.length-1&&e.jsx("div",{className:`w-12 h-1 mx-2 ${l<s?"bg-green-600":"bg-gray-200"}`})]},l))}),e.jsxs("p",{className:"text-lg font-medium text-neutral-700",children:["Step ",s+1," of ",N.length,": ",h[s]]}),d.mode==="seller"&&e.jsxs("div",{className:"mb-3 rounded-xl border bg-muted px-3 py-2 text-sm",children:["Posting as ",e.jsx("strong",{children:"Broker"})," for ",e.jsx("strong",{children:d.sellerName??`Seller #${d.sellerId}`})]})]}),e.jsx("div",{className:"my-6",children:N[s]}),e.jsxs("div",{className:"flex justify-between mt-8",children:[e.jsx(F,{variant:"ghost",onClick:()=>a(c=>Math.max(0,c-1)),disabled:s===0,children:"Back"}),e.jsx(F,{onClick:()=>a(c=>Math.min(N.length-1,c+1)),disabled:C,children:s===N.length-1?"Submit":"Next"})]})]})}function Me(){const{user:s}=Y();return s?s.role!=="seller"&&s.role!=="admin"?e.jsx(L,{children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"Access Denied"}),e.jsx("p",{className:"text-neutral-600 mb-2",children:"Only sellers and admins can create listings"}),e.jsxs("p",{className:"text-sm text-neutral-500 mb-6",children:["Your current role: ",s.role]}),e.jsx(_,{to:"/dashboard",children:e.jsx(F,{children:"Back to Dashboard"})})]})}):e.jsx(L,{children:e.jsx(Se,{})}):e.jsx(L,{children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"Login Required"}),e.jsx("p",{className:"text-neutral-600 mb-6",children:"You must be logged in to create listings"}),e.jsx(_,{to:"/auth",children:e.jsx(F,{children:"Login"})})]})})}export{Me as default};
