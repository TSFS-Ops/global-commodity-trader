import{ax as M,ay as E,az as I,aA as Q,aB as z,k as C,r as m,m as T,n as B,j as e,o as w,a3 as R,A as $,E as L,p as q,L as O,B as v,I as W,F as J,G as S,aC as b,a9 as V,z as Y,b as _,g as G,M as k,y as A}from"./index-DE3WvtMD.js";import{T as X}from"./triangle-alert-Bwh9XQm5.js";import{S as D}from"./send-DgBiCyZR.js";function Z(t,c){const l=M(t);return isNaN(c)?E(t,NaN):(l.setDate(l.getDate()+c),l)}function P(t){return E(t,Date.now())}function F(t,c){const l=I(t),o=I(c);return+l==+o}function U(t){return c=>{const o=(t?Math[t]:Math.trunc)(c);return o===0?0:o}}function H(t,c){return+M(t)-+M(c)}function ee(t,c,l){const o=H(t,c)/Q;return U(l==null?void 0:l.roundingMethod)(o)}function se(t,c,l){const o=H(t,c)/z;return U(l==null?void 0:l.roundingMethod)(o)}function te(t){return F(t,P(t))}function ae(t,c){return Z(t,-c)}function re(t){return F(t,ae(P(t),1))}function ne(){const{user:t}=C(),[c,l]=m.useState(!1),[o,x]=m.useState(null),u=m.useRef(null),h=m.useRef(new Map),y=m.useCallback(()=>{var f;if(((f=u.current)==null?void 0:f.readyState)===WebSocket.OPEN)return;const s=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws`,n=new WebSocket(s);return u.current=n,n.onopen=()=>{l(!0),console.log("WebSocket connected"),t&&n.send(JSON.stringify({type:"auth",data:{userId:t.id}}))},n.onclose=a=>{l(!1),console.log("WebSocket disconnected",a.code,a.reason),a.code!==1e3&&a.code!==1001&&t&&setTimeout(()=>{var i;t&&((i=u.current)==null?void 0:i.readyState)!==WebSocket.OPEN&&y()},5e3)},n.onerror=a=>{console.error("WebSocket error:",a),l(!1)},n.onmessage=a=>{try{if(!a.data||typeof a.data!="string"){console.warn("Received invalid WebSocket message data");return}const i=JSON.parse(a.data);x(i),i!=null&&i.type&&(h.current.get(i.type)||[]).forEach(d=>d(i.data))}catch(i){console.error("Error parsing WebSocket message:",i)}},()=>{n.close()}},[t]),g=m.useCallback(()=>{u.current&&(u.current.close(),u.current=null)},[]),p=m.useCallback((j,s)=>!u.current||u.current.readyState!==WebSocket.OPEN?(console.error("WebSocket is not connected"),!1):(u.current.send(JSON.stringify({type:j,data:s})),!0),[]),N=m.useCallback((j,s)=>{const n=h.current.get(j)||[];return h.current.set(j,[...n,s]),()=>{const f=h.current.get(j)||[];h.current.set(j,f.filter(a=>a!==s))}},[]);return m.useEffect(()=>(t?y():g(),()=>{g()}),[t,y,g]),{isConnected:c,lastMessage:o,sendMessage:p,subscribe:N,connect:y,disconnect:g}}function ie({partnerId:t,partnerName:c,onSendMessage:l}){const{user:o}=C(),[x,u]=m.useState(""),h=m.useRef(null),[y,g]=m.useState(null),{data:p,isLoading:N,isError:j}=T({queryKey:[`/api/messages/${t}`],enabled:!!t&&!!o,staleTime:10*1e3}),s=Array.isArray(p)?p:[],n=B({mutationFn:async r=>await(await J("PATCH",`/api/messages/${r}/read`,{})).json(),onSuccess:()=>{S.invalidateQueries({queryKey:["/api/messages"]}),S.invalidateQueries({queryKey:[`/api/messages/${t}`]})}});m.useEffect(()=>{var r;(r=h.current)==null||r.scrollIntoView({behavior:"smooth"})},[p]),m.useEffect(()=>{if(!p||!o)return;s.filter(d=>d.receiverId===o.id&&d.status==="unread").forEach(d=>{n.mutate(d.id)})},[p,o,n,t]);const f=()=>{if(x.trim())try{l(x)?(u(""),setTimeout(()=>{S.invalidateQueries({queryKey:[`/api/messages/${t}`]})},500)):g("Failed to send message. Please try again.")}catch{g("An error occurred while sending your message.")}},a=r=>r.split(" ").map(d=>d[0]).join("").toUpperCase(),i=r=>{const d=new Date(r),K=new Date;return d.toDateString()===K.toDateString()?b(d,"h:mm a"):b(d,"MMM d, h:mm a")};return e.jsxs(w,{className:"flex flex-col h-full",children:[e.jsxs(R,{className:"flex flex-row items-center pb-3 border-b space-y-0",children:[e.jsx($,{className:"h-10 w-10 mr-3",children:e.jsx(L,{children:a(c)})}),e.jsx("div",{children:e.jsx("div",{className:"font-medium",children:c})})]}),e.jsx(q,{className:"flex-1 overflow-y-auto p-4 space-y-4",children:N?e.jsx("div",{className:"flex justify-center items-center h-full",children:e.jsx(O,{className:"h-8 w-8 animate-spin text-primary"})}):j?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center",children:[e.jsx(X,{className:"h-12 w-12 text-destructive mb-2"}),e.jsx("h3",{className:"font-medium text-lg",children:"Failed to load messages"}),e.jsx("p",{className:"text-neutral-600",children:"There was an error loading your conversation."})]}):s&&s.length>0?e.jsxs(e.Fragment,{children:[s.map(r=>{const d=r.senderId===(o==null?void 0:o.id);return e.jsx("div",{className:`flex ${d?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[75%] rounded-lg px-4 py-2 ${d?"bg-primary text-white rounded-br-none":"bg-neutral-100 text-neutral-800 rounded-bl-none"}`,children:[e.jsx("div",{className:"break-words",children:r.content}),e.jsx("div",{className:`text-xs mt-1 ${d?"text-white/70":"text-neutral-500"}`,children:i(r.createdAt)})]})},r.id)}),e.jsx("div",{ref:h})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center",children:[e.jsx("div",{className:"p-3 rounded-full bg-neutral-100 mb-2",children:e.jsx(D,{className:"h-6 w-6 text-neutral-400"})}),e.jsx("h3",{className:"font-medium",children:"Start a conversation"}),e.jsxs("p",{className:"text-neutral-600 text-sm mt-1",children:["Send a message to ",c]})]})}),y&&e.jsx("div",{className:"px-4 py-2 bg-destructive/10 text-destructive text-sm",children:y}),e.jsxs("div",{className:"p-4 border-t space-y-3",children:[e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(v,{variant:"outline",size:"sm",onClick:()=>u("Hi! I can confirm this product is available. Let me know your requirements and I'll send you a detailed quote."),className:"text-xs",children:"Confirm Availability"}),e.jsx(v,{variant:"outline",size:"sm",onClick:()=>u("Thanks for your interest! I'll need to adjust the pricing based on your volume requirements. What quantity are you looking for?"),className:"text-xs",children:"Counter Price"}),e.jsx(v,{variant:"outline",size:"sm",onClick:()=>u("I can provide a Certificate of Analysis (COA) for this product. Would you like me to send it over along with any other compliance documentation?"),className:"text-xs",children:"Send COA"})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(W,{value:x,onChange:r=>u(r.target.value),placeholder:"Type your message...",className:"flex-1",onKeyDown:r=>{r.key==="Enter"&&f()}}),e.jsx(v,{onClick:f,disabled:!x.trim(),children:e.jsx(D,{className:"h-4 w-4"})})]})]})]})}function le({conversations:t,selectedId:c,onSelect:l}){const[o,x]=m.useState(""),[u,h]=m.useState(new Date);m.useEffect(()=>{const s=setInterval(()=>{h(new Date)},6e4);return()=>clearInterval(s)},[]);const y=t.filter(s=>s.userName.toLowerCase().includes(o.toLowerCase())),g=s=>s.split(" ").map(n=>n[0]).join("").toUpperCase(),p=s=>te(s)?b(s,"h:mm a"):re(s)?"Yesterday":b(s,"MMM d"),N=(s,n=25)=>s.length<=n?s:s.substring(0,n)+"...",j=s=>{if(!s.needsReply||!s.createdAt)return null;const n=new Date(s.createdAt),f=ee(u,n),a=se(u,n),i=24*60-a,r=Math.floor(i/60),d=i%60;return f>=48?{text:"OVERDUE",color:"text-red-600 font-semibold",isPulsing:!0,message:"Late response impacts visibility"}:f>=24?{text:`${48-f}h overdue`,color:"text-orange-600 font-semibold",isPulsing:!1,message:"Late response impacts visibility"}:r>=0?{text:`${r}:${d.toString().padStart(2,"0")}`,color:r<2?"text-orange-600":"text-blue-600",isPulsing:!1,message:"Reply within 24:00:00 for best ranking"}:null};return e.jsxs(w,{className:"h-full flex flex-col",children:[e.jsx(R,{className:"pb-3 border-b space-y-0",children:e.jsxs("div",{className:"relative",children:[e.jsx(V,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-neutral-400"}),e.jsx(W,{placeholder:"Search conversations...",value:o,onChange:s=>x(s.target.value),className:"pl-10"})]})}),e.jsx(q,{className:"p-0 flex-1 overflow-y-auto",children:y.length===0?e.jsx("div",{className:"p-4 text-center text-neutral-500",children:"No conversations found"}):e.jsx("ul",{className:"divide-y",children:y.map(s=>e.jsx("li",{children:e.jsx(v,{variant:"ghost",className:`w-full justify-start px-4 py-3 h-auto ${c===s.userId?"bg-neutral-100":""}`,onClick:()=>l(s.userId),children:e.jsxs("div",{className:"flex items-center w-full",children:[e.jsxs($,{className:"h-10 w-10 mr-3 flex-shrink-0",children:[e.jsx(Y,{src:s.userAvatar,alt:s.userName}),e.jsx(L,{children:g(s.userName)})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"font-medium truncate",children:s.userName}),e.jsx("span",{className:"text-xs text-neutral-500 whitespace-nowrap ml-2",children:p(s.lastMessageTime)})]}),e.jsxs("div",{className:"flex justify-between items-center mt-1",children:[e.jsx("span",{className:"text-sm text-neutral-600 truncate",children:N(s.lastMessage)}),s.unread>0&&e.jsx(_,{className:"ml-2 bg-primary text-white h-5 min-w-5 flex items-center justify-center rounded-full p-0 px-1.5",children:s.unread})]}),s.needsReply&&(()=>{const n=j(s);return n?e.jsxs("div",{className:"mt-2 flex items-center gap-1",children:[e.jsx(G,{className:"h-3 w-3 text-neutral-400"}),e.jsx("span",{className:`text-xs ${n.color} ${n.isPulsing?"animate-pulse":""}`,children:n.text}),n.message&&e.jsxs("span",{className:"text-xs text-neutral-500 ml-1",children:["- ",n.message]})]}):null})()]})]})})},s.userId))})})]})}function me(){var j;const{user:t}=C(),{sendMessage:c,subscribe:l,isConnected:o}=ne(),[x,u]=m.useState(null),[h,y]=m.useState([]),{data:g,isLoading:p}=T({queryKey:["/api/messages"],enabled:!!t,staleTime:30*1e3});m.useEffect(()=>{if(!g||!t)return;const s=new Map;(Array.isArray(g)?g:[]).forEach(a=>{const i=a.senderId===t.id?a.receiverId:a.senderId;if(s.has(i)){const r=s.get(i),d=new Date(a.createdAt);d>r.lastMessageTime?(r.lastMessage=a.content,r.lastMessageTime=d,a.senderId!==t.id&&a.status==="unread"&&(r.unread+=1),s.set(i,r)):a.senderId!==t.id&&a.status==="unread"&&(r.unread+=1,s.set(i,r))}else{const r=a.senderId===t.id?a.receiverName||`User #${i}`:a.senderName||`User #${i}`;s.set(i,{userId:i,userName:r,userAvatar:a.senderId===t.id?a.receiverAvatar:a.senderAvatar,lastMessage:a.content,lastMessageTime:new Date(a.createdAt),unread:a.senderId!==t.id&&a.status==="unread"?1:0})}});const f=Array.from(s.values()).sort((a,i)=>i.lastMessageTime.getTime()-a.lastMessageTime.getTime());y(f),x===null&&f.length>0&&u(f[0].userId)},[g,t]),m.useEffect(()=>{if(!t)return;const s=l("new_message",n=>{window.location.reload()});return()=>{s()}},[t,l]);const N=s=>!x||!o?!1:(c("new_message",{receiverId:x,content:s}),!0);return t?e.jsxs(k,{children:[e.jsx("div",{className:"mb-6",children:e.jsx("h1",{className:"text-2xl font-bold text-neutral-800",children:"Messages"})}),p?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(O,{className:"h-8 w-8 animate-spin text-primary"})}):h.length===0?e.jsxs(w,{className:"p-8 text-center",children:[e.jsx(A,{className:"h-12 w-12 text-neutral-300 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"No messages yet"}),e.jsx("p",{className:"text-neutral-600",children:"You haven't started any conversations. Visit product listings to contact sellers."})]}):e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 h-[calc(100vh-12rem)]",children:[e.jsx("div",{className:"md:col-span-1 overflow-hidden",children:e.jsx(le,{conversations:h,selectedId:x,onSelect:u})}),e.jsx("div",{className:"md:col-span-2 overflow-hidden",children:x?e.jsx(ie,{partnerId:x,partnerName:((j=h.find(s=>s.userId===x))==null?void 0:j.userName)||"",onSendMessage:N}):e.jsx(w,{className:"p-8 text-center h-full flex items-center justify-center",children:e.jsxs("div",{children:[e.jsx(A,{className:"h-12 w-12 text-neutral-300 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"Select a conversation"}),e.jsx("p",{className:"text-neutral-600",children:"Choose a conversation from the list to start messaging"})]})})})]})]}):e.jsx(k,{children:e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h2",{className:"text-xl font-medium mb-2",children:"Authentication required"}),e.jsx("p",{className:"text-neutral-600 mb-4",children:"Please log in to view your messages"})]})})})}export{me as default};
